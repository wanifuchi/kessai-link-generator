# API設定データ移行ガイド

## 概要

このガイドでは、既存のApiSettingsテーブルから新しいUserPaymentConfigテーブルへのデータ移行手順を説明します。この移行により、API認証情報が暗号化され、セキュリティが向上します。

## 移行の目的

- **セキュリティ強化**: API認証情報をAES-256暗号化で保護
- **データ構造最適化**: より柔軟で拡張可能なテーブル設計
- **マルチテナント対応**: ユーザー固有の設定管理の改善

## 移行前の準備

### 1. 環境変数の確認

暗号化に必要な環境変数が設定されていることを確認してください：

```bash
# .env.local で確認
ENCRYPTION_SECRET=your-256-bit-secret-key
```

### 2. データベースバックアップ

移行前に必ずデータベースの完全バックアップを取得してください：

```bash
# PostgreSQL の場合
pg_dump -h hostname -U username -d database_name > backup_$(date +%Y%m%d_%H%M%S).sql

# または Prisma を使用した場合
npx prisma db seed --preview-feature
```

### 3. アプリケーションの停止

移行中はアプリケーションを停止してデータの整合性を保ってください。

## 移行手順

### ステップ 1: 移行状況の確認

```bash
npm run migrate:status
```

このコマンドで現在のデータベース状況を確認できます。

### ステップ 2: データ移行の実行

```bash
npm run migrate:api-settings
```

移行スクリプトが以下の処理を実行します：

1. **既存データの取得**: ApiSettingsテーブルからユーザー紐付きデータを取得
2. **重複チェック**: UserPaymentConfigに同じ設定が存在しないか確認
3. **データ暗号化**: 認証情報をAES-256で暗号化
4. **新形式での保存**: UserPaymentConfigテーブルに暗号化データを保存
5. **移行結果の報告**: 成功・失敗件数の表示

### ステップ 3: 移行結果の検証

移行スクリプト実行後、以下を確認してください：

1. **件数確認**: 移行前後のデータ件数が一致しているか
2. **暗号化テスト**: サンプルデータの暗号化・復号化が正常に動作するか
3. **アプリケーションテスト**: 新しいUserPaymentConfigを使用した機能が正常に動作するか

### ステップ 4: アプリケーション動作確認

1. **開発サーバー起動**:
   ```bash
   npm run dev
   ```

2. **API設定機能のテスト**:
   - 新しいAPI設定の作成
   - 既存設定の編集
   - 設定の削除
   - 決済機能の動作確認

### ステップ 5: 旧データのクリーンアップ

アプリケーションが正常に動作することを確認後、旧データを削除：

```bash
npm run migrate:cleanup-old-settings
```

⚠️ **注意**: このコマンドは不可逆的操作です。実行前に必ずバックアップを確認してください。

## トラブルシューティング

### よくある問題と解決方法

#### 1. 暗号化エラー
```
Error: Encryption failed
```

**解決方法**:
- `ENCRYPTION_SECRET`環境変数が正しく設定されているか確認
- 秘密キーが256ビット（64文字の16進数）であることを確認

#### 2. 重複エラー
```
Error: Duplicate entry for user/provider/displayName
```

**解決方法**:
- 既に移行済みのデータが存在する可能性
- `--force`オプションまたは手動でのデータクリーンアップを検討

#### 3. データベース接続エラー
```
Error: Can't reach database server
```

**解決方法**:
- `DATABASE_URL`環境変数が正しく設定されているか確認
- データベースサーバーが起動しているか確認
- ネットワーク接続を確認

### 緊急時の復旧手順

移行に問題が発生した場合の復旧方法：

1. **アプリケーション停止**:
   ```bash
   pkill -f "next dev"
   ```

2. **バックアップからの復元**:
   ```bash
   # PostgreSQL の場合
   psql -h hostname -U username -d database_name < backup_file.sql
   ```

3. **Prisma クライアント再生成**:
   ```bash
   npx prisma generate
   ```

4. **移行スクリプトの再実行** (必要に応じて)

## 移行後の確認項目

### 機能確認チェックリスト

- [ ] **新規API設定作成**: 各決済プロバイダーでの設定作成
- [ ] **既存設定編集**: 暗号化データの正常な読み書き
- [ ] **設定削除**: データの完全削除
- [ ] **決済機能**: 各プロバイダーでの決済処理
- [ ] **認証機能**: NextAuth.jsとの連携
- [ ] **エラーハンドリング**: 無効な設定での適切なエラー表示

### セキュリティ確認

- [ ] **暗号化確認**: データベース内の認証情報が暗号化されている
- [ ] **復号化確認**: アプリケーションで正常に復号化できる
- [ ] **ログ確認**: 平文の認証情報がログに出力されていない
- [ ] **環境変数**: ENCRYPTION_SECRETが適切に保護されている

## パフォーマンス

### 移行時間の目安

| データ件数 | 推定時間 |
|------------|----------|
| ~100件     | 1-2分    |
| ~1,000件   | 5-10分   |
| ~10,000件  | 30-60分  |

### システムリソース

- **CPU使用率**: 暗号化処理により一時的に増加
- **メモリ使用量**: 大量データの場合は監視が必要
- **データベース負荷**: トランザクション処理による負荷

## セキュリティ考慮事項

### 暗号化の詳細

- **アルゴリズム**: AES-256-CBC
- **キー長**: 256ビット
- **ライブラリ**: crypto-js
- **IVランダム化**: 各暗号化で異なるIVを使用

### 環境変数管理

- **本番環境**: 環境変数管理サービス（AWS Parameter Store等）の使用を推奨
- **開発環境**: .env.localファイルで管理、.gitignoreで除外
- **ステージング環境**: 本番同等のセキュリティレベルを維持

## サポート

移行に関する問題が発生した場合：

1. **ログ確認**: `logs/migration.log`でエラー詳細を確認
2. **バックアップ確認**: 移行前バックアップの整合性を確認
3. **環境確認**: 必要な環境変数とパッケージが正しく設定されているか確認

---

**重要**: 本番環境での移行前には、必ずステージング環境で完全なテストを実施してください。